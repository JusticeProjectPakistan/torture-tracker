<!DOCTYPE html>
<html lang="en">

<head>
    <title>User Information</title>
    <meta name="viewport" content="width=device-width" />

    <!-- core -->
    <script src="https://unpkg.com/knockout@3.5.1/build/output/knockout-latest.js"></script>
    <script src="https://unpkg.com/survey-knockout@1.8.58/survey.ko.min.js"></script>
    <link href="https://unpkg.com/survey-core@1.8.58/modern.min.css" type="text/css" rel="stylesheet" />

    <!-- tag box -->
    <script src="https://unpkg.com/jquery"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/js/select2.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/css/select2.min.css" rel="stylesheet" />

    <!-- <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/themes/smoothness/jquery-ui.css" type="text/css" rel="stylesheet" /> -->

    <script src="https://unpkg.com/surveyjs-widgets@1.8.59/surveyjs-widgets.min.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <!-- other -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://unpkg.com/aws4fetch@1.0.5/dist/aws4fetch.umd.js"></script>

    <!-- local -->
    <link rel="stylesheet" href="../css/survey.css">

</head>

<body>

    <!-- ERRORS -->
    <div id="error-modal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sorry...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>It looks like your submission failed. Verify your connectivity and try again. If the problem persists contact <a href="https://jpp.org.pk/contact/">JPP</a>.</p>
                    <p></p>
                    <p>AWS status: <span id="error-status"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="chooserContainer" style="display:inline-block;width:100%;"></div>
    <div id="surveyContainer" style="display:inline-block;width:86%;margin:0 7%;"></div>
    <!-- <div id="surveyResult"></div> -->

    <!-- Get question names -->
    <!-- <script type="module">
        import layout from "../js/entry.js"; window.qNames = Object.keys(layout).flatMap(d => layout[d]).map(d => d.Type!='array'?d.Name:undefined).filter(d => d);
    </script> -->
    <script>
        let lang = navigator.language.startsWith('ur') ? 'ur' : 'en';

        function awsSubmit(obj) {
            let data = obj.getAllValues();

            let url = "https://12cao4lu68.execute-api.us-east-1.amazonaws.com/production/v1/submitSurvey";
            let awsCfg = {
                method: 'POST',
                body: JSON.stringify({
                    data,
                    lang
                })

            };

            const aws = new aws4fetch.AwsClient({
                accessKeyId: 'none',
                secretAccessKey: 'none',
                retries: 3
            });
            console.log('Submitting survey', data)

            function errModal(admMsg, usrMsg) {
                var errorModal = new bootstrap.Modal(document.getElementById('error-modal')); // ERROR MODAL
                console.error(admMsg);
                $('#error-modal #error-status').html(usrMsg);
                errorModal.show();
                // cfg.rvFcn();
            }

            async function call(url, opts) {
                const response = await aws.fetch(url, opts);

                if (response.status != 201) {
                    errModal('AWS Fetch ERROR:' + response, response.status);
                }
                return response;
            }

            call(url, awsCfg);
        }

        function modQI(ev, el) {

            let e = $(el.htmlElement).parent().parent().parent();
            // some have the name a level up
            let n = e.attr('name') || $(el.htmlElement).parent().parent().attr('name');

            let href = `./info.html#${n}`;
            let dir = lang == 'ur' ? 'left' : 'right';
            let style = `text-decoration: none;float: ${dir}; color:#222;`;
            // Functionality pushed as needed text was never available
            // e.find('.sv-title').prepend(`<a class="far fa-question-circle" href="${href}" target="_blank" rel="noopener noreferrer" style="${style}"></a>`);

            // move dropdown arrows left
            // $(".sv-dropdown").css('background-position', 'left .1em top 50%, 0 0')
            $("[type='date']").css('background-image', 'unset')
        }

        let surveyCfg = {
            title: "Torture Incident Survey.",
            completedHtml: "<h3>Thank you for your submission.</h3> <h5>We would be happy to send you more information, hear about a case referral, or get you involved!</h5><h6 style='cursor: pointer; transform:translateY(3rem);''>You may now close this tab.</h6>",
            onComplete: awsSubmit,
            onAfterRenderQuestionInput: modQI,
            lang
        };
    </script>
    <script type="module">
        import SurveyUtil from "../js/survey.js"; let survey = new SurveyUtil(); survey.init(surveyCfg);
    </script>
</body>

</html>